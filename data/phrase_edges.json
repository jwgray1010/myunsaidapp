{
  "version": "1.6",
  "notes": "Phrase-edges++: macros, guards, per-edge cooldowns, locales, combo rules, safer Unicode word boundaries, and scoring.",
  "globals": {
    "regexFlags": "iu",
    "maxInputChars": 2400,
    "timeoutMs": 16,
    "dedupeWindowMs": 600,
    "matchLimitPerMessage": 8,
    "apostropheClass": "['’`´]",
    "normalize": ["NFC","trim","squashSpaces"],
    "tokenBoundary": "(?:(?<=\\W)|^)(?=\\P{M}*\\p{L}|\\d)|(?<=\\p{L}|\\d)(?=\\W|$)",
    "ignoreZones": ["url","email","code_block","blockquote>direct","inline_citation","quoted_title"],
    "language": { "default": "en", "fallbacks": ["en-US","en-GB"] }
  },

  "priorityOrder": [
    "rupture","escalation","boundary","shutdown","absolutizing",
    "repair_initiator","reconnection","logistics_pivot","tentative_disclosure"
  ],

  "cooldownsMsByCategory": {
    "rupture": 15000, "escalation": 12000, "shutdown": 10000, "boundary": 8000,
    "absolutizing": 8000, "repair_initiator": 6000, "reconnection": 6000,
    "logistics_pivot": 4000, "tentative_disclosure": 4000
  },

  "caps": { "maxAppliedPerMessage": 2, "categoryCap": { "escalation": 2, "rupture": 1 } },

  "interaction": {
    "negationPenalty": 0.03,
    "sarcasmPenalty": 0.04,
    "positionBoost": { "start": 0.03, "end": 0.015, "allCaps": 0.04, "repeat": 0.03 },
    "comboBoost": [
      { "whenAll": ["absolutizing","escalation"], "boost": 0.06 },
      { "whenAll": ["boundary","reconnection"], "boost": -0.04 }
    ]
  },

  "scoring": {
    "weights": { "edgeBoost": 0.6, "position": 0.15, "combos": 0.15, "context": 0.1 },
    "fireThresholdByCategory": {
      "rupture": 0.28, "escalation": 0.25, "boundary": 0.22, "shutdown": 0.20,
      "absolutizing": 0.20, "repair_initiator": 0.18, "reconnection": 0.18,
      "logistics_pivot": 0.16, "tentative_disclosure": 0.16
    }
  },

  "guards": {
    "quotedSpeech": { "reduce": 0.25, "maxQuoteLen": 160 },
    "banterSofteners": { "markers": ["lol","jk","😉","😅","😂","lmao"], "withinTokens": 6, "dampen": 0.06 },
    "emphatics": { "multiPunct": "[!?]{2,}|\\?!", "boost": 0.03, "cap": 0.06 }
  },

  "links": {
    "negation": { "windowTokens": 5, "denylist": ["not only","not because"] },
    "sarcasmModule": { "enabled": true, "source": "irony_sarcasm_v1.2" },
    "attachmentOverrides": {
      "anxious": { "cautionBoost": 0.10, "alertDampen": 0.04 },
      "avoidant": { "clearBoost": 0.10, "cautionBoost": 0.05 },
      "disorganized": { "alertBoost": 0.10, "cautionBoost": 0.10 },
      "secure": { "clearBoost": 0.12 }
    }
  },

  "classes": {
    "YOU": "(?:you|u|ya)",
    "IM": "i(?:${APO})?m",
    "APO": "['’`´]",
    "DONT": "don(?:${APO})?t|do(?:${APO})?nt|doe(?:${APO})?t|dont",
    "ALWAYS": "(?:always|every\\s*time|all\\s*the\\s*time)",
    "NEVER": "(?:never|no\\s*longer)",
    "NEG": "(?:no|not|never|hardly|scarcely)",
    "SPACE": "\\s+",
    "END_PUNCT": "(?:[.!?]+)?"
  },

  "locales": {
    "en": { "enabled": true },
    "es": {
      "enabled": true,
      "edges": [
        { "pattern": "\\bno quiero hablar (contigo|de esto)\\b", "boost": 0.28, "category": "boundary", "toneBias": { "caution": 0.04 } },
        { "pattern": "\\bsiempre (haces|arruinas)\\b", "boost": 0.28, "category": "escalation", "toneBias": { "alert": 0.08 } }
      ]
    }
  },

  "edgeDefaults": {
    "exceptZones": ["url","email","code_block","quoted_title"],
    "exceptPattern": null,
    "exceptWindowTokens": 10,
    "perEdgeCooldownMs": 4000,
    "safeRegex": true
  },

  "edges": [
    {
      "id": "RUPTURE_IM_DONE",
      "pattern": "(?<=^|\\W)${IM}${SPACE}done(?:${SPACE}with${SPACE}(?:this|${YOU}))?${END_PUNCT}(?=$|\\W)",
      "boost": 0.34,
      "category": "rupture",
      "toneBias": { "alert": 0.10 },
      "contextHint": ["conflict","boundary"],
      "exceptPattern": "(?i)done${SPACE}for${SPACE}today",
      "perEdgeCooldownMs": 12000
    },
    {
      "id": "RUPTURE_FORGET_IT",
      "pattern": "(?<=^|\\W)forget${SPACE}it(?!${SPACE}(?:for${SPACE}now|please))",
      "boost": 0.30,
      "category": "rupture",
      "toneBias": { "alert": 0.08 },
      "contextHint": ["conflict"]
    },
    {
      "id": "RUPTURE_STOP_TEXTING",
      "pattern": "(?<=^|\\W)(?:stop|quit)${SPACE}texting${SPACE}me\\b",
      "boost": 0.30,
      "category": "rupture",
      "toneBias": { "alert": 0.09 },
      "contextHint": ["boundary"]
    },
    {
      "id": "SHUTDOWN_WHATEVER",
      "pattern": "(?<=^|\\W)whatever\\b(?!${SPACE}you${SPACE}need)",
      "boost": 0.25,
      "category": "shutdown",
      "toneBias": { "alert": 0.06 },
      "contextHint": ["conflict","withdrawal"]
    },
    {
      "id": "SHUTDOWN_DONT_CARE",
      "pattern": "(?<=^|\\W)i${SPACE}${DONT}${SPACE}care\\b",
      "boost": 0.27,
      "category": "shutdown",
      "toneBias": { "alert": 0.06 },
      "contextHint": ["withdrawal"]
    },
    {
      "id": "ABS_ALWAYS_NEVER_YOU",
      "pattern": "(?<=^|\\W)(?:you|we)${SPACE}(?:${ALWAYS}|${NEVER})${SPACE}(?:do|say|forget)\\b",
      "boost": 0.24,
      "category": "absolutizing",
      "toneBias": { "alert": 0.06 },
      "contextHint": ["conflict"]
    },
    {
      "id": "BOUNDARY_NOT_OKAY",
      "pattern": "(?<=^|\\W)that${APO}?s${SPACE}not${SPACE}ok(?:ay)?\\b",
      "boost": 0.26,
      "category": "boundary",
      "toneBias": { "clear": 0.06 },
      "contextHint": ["boundary","conflict"]
    },
    {
      "id": "ESCALATION_YOU_NEVER_LISTEN",
      "pattern": "(?<=^|\\W)you${SPACE}never${SPACE}listen\\b",
      "boost": 0.31,
      "category": "escalation",
      "toneBias": { "alert": 0.10 },
      "contextHint": ["conflict","blame"]
    },
    {
      "id": "REPAIR_IM_SORRY",
      "pattern": "(?<=^|\\W)i${SPACE}${APO}?m${SPACE}sorry\\b",
      "boost": 0.26,
      "category": "repair_initiator",
      "toneBias": { "caution": 0.05 },
      "contextHint": ["repair","apology"],
      "negationSensitive": true
    },
    {
      "id": "RECON_CAN_WE_TALK",
      "pattern": "(?<=^|\\W)can${SPACE}we${SPACE}talk\\b",
      "boost": 0.20,
      "category": "reconnection",
      "toneBias": { "caution": 0.04 },
      "contextHint": ["reconnection","repair"]
    },
    {
      "id": "LOGI_PICK_A_TIME",
      "pattern": "(?<=^|\\W)can${SPACE}we${SPACE}(?:pick|set)${SPACE}a${SPACE}time\\b",
      "boost": 0.17,
      "category": "logistics_pivot",
      "toneBias": { "clear": 0.04 },
      "contextHint": ["planning"]
    },
    {
      "id": "TENT_I_GUESS",
      "pattern": "(?<=^|\\W)i${SPACE}guess\\b(?!${SPACE}we${SPACE}can${SPACE}meet)",
      "boost": 0.17,
      "category": "tentative_disclosure",
      "toneBias": { "caution": 0.03 },
      "contextHint": ["vulnerability"]
    }
  ],

  "combos": [
    {
      "id": "COMBO_ABS_ESCALATE",
      "when": ["ABS_ALWAYS_NEVER_YOU","ESCALATION_YOU_NEVER_LISTEN"],
      "windowTokens": 20,
      "extraBoost": 0.07,
      "reclassifyTo": "escalation"
    },
    {
      "id": "COMBO_BOUNDARY_REPAIR",
      "when": ["BOUNDARY_NOT_OKAY","REPAIR_IM_SORRY"],
      "windowTokens": 30,
      "extraBoost": -0.05,
      "reclassifyTo": "repair_initiator"
    }
  ],

  "exceptions": {
    "titles": ["The End of the Conversation","Always On"],
    "idioms": ["never mind","always welcome"],
    "whitelist": [
      { "pattern": "\\bavailable all the time\\b", "appliesTo": ["absolutizing"] }
    ]
  },

  "outputs": {
    "fire": { "emit": true, "maxPerMessage": 3 },
    "emitFields": ["id","category","score","cooldownMs","toneBias","contextHint","span"]
  },

  "tests": [
    { "text": "I’m done with this. Forget it.", "expect": { "fires": ["RUPTURE_IM_DONE","RUPTURE_FORGET_IT"], "categoryTop": "rupture" } },
    { "text": "You never listen and you always make it about you!", "expect": { "fires": ["ESCALATION_YOU_NEVER_LISTEN","ABS_ALWAYS_NEVER_YOU"], "combo": "COMBO_ABS_ESCALATE" } },
    { "text": "That’s not okay. Can we talk at 7?", "expect": { "fires": ["BOUNDARY_NOT_OKAY","RECON_CAN_WE_TALK"], "categoryTop": "boundary" } },
    { "text": "Whatever…", "expect": { "fires": ["SHUTDOWN_WHATEVER"] } },
    { "text": "Quoting: “We’re done.”", "expect": { "fires<=:": 0 } }
  ]
}